generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Lead {
  id            String        @id @default(cuid())
  fullName      String
  mobileNumber  String
  businessName  String
  websiteUrl    String
  reason        String
  email         String?
  name          String?
  phone         String?
  website       String?
  source        String?
  pagePath      String?
  consentWeekly Boolean       @default(false)
  auditReport   Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  scans         WebsiteScan[]
  auditRuns     AuditRun[]
  simulatorRuns SimulatorRun[]
  events        Event[]

  @@index([createdAt])
  @@index([businessName])
  @@index([email])
  @@index([source])
}

model User {
  id           String               @id @default(cuid())
  email        String               @unique
  passwordHash String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  subscriptions       Subscription[]
  bespokePlanRequests BespokePlanRequest[]
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String
  plan      String
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BespokePlanRequest {
  id                  String   @id @default(cuid())
  userId              String?
  name                String
  email               String
  phone               String
  company             String
  website             String?
  industry            String?
  track               String
  monthlyRevenueRange String?
  leadVolumeRange     String?
  biggestBlocker      String
  preferredContact    String
  notes               String?
  selectedModules     Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([track])
  @@index([createdAt])
}

model WebsiteScan {
  id             String    @id @default(cuid())
  leadId         String
  status         ScanStatus @default(QUEUED)
  websiteUrl     String
  concern        String
  industry       String
  progress       Int       @default(0)
  scores         Json?
  insights       Json?
  recommendations Json?
  reportPath     String?
  rawResult      Json?
  errorMessage   String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([status])
  @@index([createdAt])
}

enum ScanStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

model AuditRun {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  url        String
  scoresJson Json
  leadId     String?
  reportId   String?

  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)
  events        Event[]
  simulatorRuns SimulatorRun[]

  @@index([createdAt])
  @@index([leadId])
  @@index([url])
  @@index([reportId])
}

model Event {
  id         String   @id @default(cuid())
  type       String
  payloadJson Json?
  createdAt  DateTime @default(now())
  leadId     String?
  auditRunId String?
  simulatorRunId String?

  lead         Lead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)
  auditRun     AuditRun?     @relation(fields: [auditRunId], references: [id], onDelete: SetNull)
  simulatorRun SimulatorRun? @relation(fields: [simulatorRunId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([createdAt])
  @@index([leadId])
  @@index([auditRunId])
  @@index([simulatorRunId])
}

model SimulatorRun {
  id                  String   @id @default(cuid())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  leadId              String?
  auditRunId          String?
  domain              String?
  businessName        String?
  industry            String
  offerType           String
  goal                String
  locationIntent      String
  visitors            Int
  conversionRate      Float
  avgOrderValue       Float
  closeRate           Float
  grossMargin         Float?
  responseTimeMinutes Int
  followups           Int
  leadCapturePoints   Json?
  trustSignals        Json?
  outputs             Json
  currency            String   @default("GBP")

  lead     Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  auditRun AuditRun? @relation(fields: [auditRunId], references: [id], onDelete: SetNull)
  events   Event[]

  @@index([createdAt])
  @@index([leadId])
  @@index([auditRunId])
  @@index([domain])
}
