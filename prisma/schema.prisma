generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Lead {
  id            String        @id @default(cuid())
  fullName      String
  mobileNumber  String
  businessName  String
  websiteUrl    String
  reason        String
  email         String?
  name          String?
  phone         String?
  website       String?
  source        String?
  pagePath      String?
  consentWeekly Boolean       @default(false)
  auditReport   Json?
  intentTier    String        @default("Warm")
  nextAction    String?
  status        String        @default("New")
  notes         String?
  lastSeenAt    DateTime?
  leadScore     Int           @default(0)
  leadTemperature String      @default("cold")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  scans         WebsiteScan[]
  auditRuns     AuditRun[]
  simulatorRuns SimulatorRun[]
  events        Event[]
  generatedMessages GeneratedMessage[]
  automationTasks AutomationTask[]
  portalSessions PortalSession[]
  auditSnapshots AuditSnapshot[]
  simulatorSnapshots SimulatorSnapshot[]

  @@index([createdAt])
  @@index([businessName])
  @@index([email])
  @@index([source])
  @@index([lastSeenAt])
  @@index([intentTier])
  @@index([status])
  @@index([leadScore])
  @@index([leadTemperature])
}

model User {
  id           String               @id @default(cuid())
  email        String               @unique
  passwordHash String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  subscriptions       Subscription[]
  bespokePlanRequests BespokePlanRequest[]
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String
  plan      String
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BespokePlanRequest {
  id                  String   @id @default(cuid())
  userId              String?
  name                String
  email               String
  phone               String
  company             String
  website             String?
  industry            String?
  track               String
  monthlyRevenueRange String?
  leadVolumeRange     String?
  biggestBlocker      String
  preferredContact    String
  notes               String?
  selectedModules     Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([track])
  @@index([createdAt])
}

model WebsiteScan {
  id             String    @id @default(cuid())
  leadId         String
  status         ScanStatus @default(QUEUED)
  websiteUrl     String
  concern        String
  industry       String
  progress       Int       @default(0)
  scores         Json?
  insights       Json?
  recommendations Json?
  reportPath     String?
  rawResult      Json?
  errorMessage   String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([status])
  @@index([createdAt])
}

enum ScanStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

model AuditRun {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  url        String
  scoresJson Json
  snapshotJson Json?
  leadId     String?
  reportId   String?

  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)
  events        Event[]
  simulatorRuns SimulatorRun[]
  generatedMessages GeneratedMessage[]
  snapshots    AuditSnapshot[]

  @@index([createdAt])
  @@index([leadId])
  @@index([url])
  @@index([reportId])
}

model Event {
  id         String   @id @default(cuid())
  type       String
  payloadJson Json?
  createdAt  DateTime @default(now())
  leadId     String?
  auditRunId String?
  simulatorRunId String?

  lead         Lead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)
  auditRun     AuditRun?     @relation(fields: [auditRunId], references: [id], onDelete: SetNull)
  simulatorRun SimulatorRun? @relation(fields: [simulatorRunId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([createdAt])
  @@index([leadId])
  @@index([auditRunId])
  @@index([simulatorRunId])
}

model SimulatorRun {
  id                  String   @id @default(cuid())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  leadId              String?
  auditRunId          String?
  domain              String?
  businessName        String?
  industry            String
  offerType           String
  goal                String
  locationIntent      String
  visitors            Int
  conversionRate      Float
  avgOrderValue       Float
  closeRate           Float
  grossMargin         Float?
  responseTimeMinutes Int
  followups           Int
  leadCapturePoints   Json?
  trustSignals        Json?
  outputs             Json
  currency            String   @default("GBP")

  lead     Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  auditRun AuditRun? @relation(fields: [auditRunId], references: [id], onDelete: SetNull)
  events   Event[]
  generatedMessages GeneratedMessage[]
  snapshots SimulatorSnapshot[]

  @@index([createdAt])
  @@index([leadId])
  @@index([auditRunId])
  @@index([domain])
}

model GeneratedMessage {
  id                   String   @id @default(cuid())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  leadId               String
  auditRunId           String?
  simulatorRunId       String?
  domain               String
  weakestFunnelStage   String
  topFindings          Json
  estimatedRevenueGain String
  urgencyFactor        String
  emailVersion         String
  whatsappVersion      String
  smsVersion           String
  callScriptVersion    String

  lead         Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  auditRun     AuditRun?    @relation(fields: [auditRunId], references: [id], onDelete: SetNull)
  simulatorRun SimulatorRun? @relation(fields: [simulatorRunId], references: [id], onDelete: SetNull)

  @@index([leadId, createdAt])
  @@index([auditRunId])
  @@index([simulatorRunId])
}

model AutomationTask {
  id        String   @id @default(cuid())
  leadId    String
  type      String
  priority  String
  status    String   @default("pending")
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
  @@index([status])
}

model PortalSession {
  id        String   @id @default(cuid())
  leadId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
  @@index([expiresAt])
}

model AuditSnapshot {
  id           String   @id @default(cuid())
  leadId       String
  auditRunId   String?
  snapshotJson Json
  createdAt    DateTime @default(now())

  lead     Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  auditRun AuditRun? @relation(fields: [auditRunId], references: [id], onDelete: SetNull)

  @@index([leadId, createdAt])
  @@index([auditRunId])
}

model SimulatorSnapshot {
  id             String   @id @default(cuid())
  leadId         String
  simulatorRunId String?
  snapshotJson   Json
  createdAt      DateTime @default(now())

  lead         Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  simulatorRun SimulatorRun? @relation(fields: [simulatorRunId], references: [id], onDelete: SetNull)

  @@index([leadId, createdAt])
  @@index([simulatorRunId])
}
